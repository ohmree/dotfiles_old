'use strict';(function(k){"object"==typeof exports&&"object"==typeof module?k(require("../lib/codemirror"),require("../addon/search/searchcursor"),require("../addon/edit/matchbrackets")):"function"==typeof define&&define.amd?define(["../lib/codemirror","../addon/search/searchcursor","../addon/edit/matchbrackets"],k):k(CodeMirror)})(function(k){function t(a,c){a.extendSelectionsBy(function(d){if(a.display.shift||a.doc.extend||d.empty()){var h;var m=a.doc;d=d.head;if(0>c&&0==d.ch)h=m.clipPos(l(d.line-
1));else{var b=m.getLine(d.line);if(0<c&&d.ch>=b.length)h=m.clipPos(l(d.line+1,0));else{for(var m="start",g=d.ch,f=0>c?0:b.length,e=0;g!=f;g+=c,e++){var q=b.charAt(0>c?g-1:g),p="_"!=q&&k.isWordChar(q)?"w":"o";"w"==p&&q.toUpperCase()==q&&(p="W");if("start"==m)"o"!=p&&(m="in",h=p);else if("in"==m&&h!=p)if("w"==h&&"W"==p&&0>c&&g--,"W"==h&&"w"==p&&0<c)h="w";else break}h=l(d.line,g)}}return h}return 0>c?d.from():d.to()})}function u(a,c){a.operation(function(){for(var d=a.listSelections().length,h=[],m=
-1,b=0;b<d;b++){var g=a.listSelections()[b].head;g.line<=m||(m=l(g.line+(c?0:1),0),a.replaceRange("\n",m,null,"+insertLine"),a.indentLine(m.line,null,!0),h.push({head:m,anchor:m}),m=g.line+1)}a.setSelections(h)})}function r(a,c){for(var d=c.ch,h=d,m=a.getLine(c.line);d&&k.isWordChar(m.charAt(d-1));)--d;for(;h<m.length&&k.isWordChar(m.charAt(h));)++h;return{from:l(c.line,d),to:l(c.line,h),word:m.slice(d,h)}}function v(a){var c=a.getCursor(),d=a.scanForBracket(c,-1);if(d)for(;;){c=a.scanForBracket(c,
1);if(!c)break;if(c.ch=="(){}[]".charAt("(){}[]".indexOf(d.ch)+1))return a.setSelection(l(d.pos.line,d.pos.ch+1),c.pos,!1),!0;c=l(c.pos.line,c.pos.ch+1)}}function w(a,c){for(var d=a.listSelections(),h=[],m,b=0;b<d.length;b++){var g=d[b];if(!g.empty()){for(var f=g.from().line,e=g.to().line;b<d.length-1&&d[b+1].from().line==e;)e=g[++b].to().line;h.push(f,e)}}h.length?m=!0:h.push(a.firstLine(),a.lastLine());a.operation(function(){for(var d=[],b=0;b<h.length;b+=2){var g=h[b+1],e=l(h[b],0),g=l(g),f=a.getRange(e,
g,!1);c?f.sort():f.sort(function(a,c){var d=a.toUpperCase(),h=c.toUpperCase();d!=h&&(a=d,c=h);return a<c?-1:a==c?0:1});a.replaceRange(f,e,g);m&&d.push({anchor:e,head:g})}m&&a.setSelections(d,0)})}function x(a,c){a.operation(function(){for(var d=a.listSelections(),h=[],b=[],e=0;e<d.length;e++){var g=d[e];g.empty()?(h.push(e),b.push("")):b.push(c(a.getRange(g.from(),g.to())))}a.replaceSelections(b,"around","case");for(var e=h.length-1,f;0<=e;e--)g=d[h[e]],f&&0<k.cmpPos(g.head,f)||(b=r(a,g.head),f=b.from,
a.replaceRange(c(b.word),b.from,b.to))})}function y(a){var c=a.getCursor("from"),d=a.getCursor("to");if(0==k.cmpPos(c,d)){var h=r(a,c);if(!h.word)return;c=h.from;d=h.to}return{from:c,to:d,query:a.getRange(c,d),word:h}}function z(a,c){var d=y(a);if(d){var h=d.query,b=a.getSearchCursor(h,c?d.to:d.from);(c?b.findNext():b.findPrevious())?a.setSelection(b.from(),b.to()):(b=a.getSearchCursor(h,c?l(a.firstLine(),0):a.clipPos(l(a.lastLine()))),(c?b.findNext():b.findPrevious())?a.setSelection(b.from(),b.to()):
d.word&&a.setSelection(d.from,d.to))}}var b=k.keyMap.sublime={fallthrough:"default"},f=k.commands,l=k.Pos,n=k.keyMap["default"]==k.keyMap.macDefault,e=n?"Cmd-":"Ctrl-";f[b["Alt-Left"]="goSubwordLeft"]=function(a){t(a,-1)};f[b["Alt-Right"]="goSubwordRight"]=function(a){t(a,1)};var A=n?"Ctrl-Alt-":"Ctrl-";f[b[A+"Up"]="scrollLineUp"]=function(a){var c=a.getScrollInfo();if(!a.somethingSelected()){var d=a.lineAtHeight(c.top+c.clientHeight,"local");a.getCursor().line>=d&&a.execCommand("goLineUp")}a.scrollTo(null,
c.top-a.defaultTextHeight())};f[b[A+"Down"]="scrollLineDown"]=function(a){var c=a.getScrollInfo();if(!a.somethingSelected()){var d=a.lineAtHeight(c.top,"local")+1;a.getCursor().line<=d&&a.execCommand("goLineDown")}a.scrollTo(null,c.top+a.defaultTextHeight())};f[b["Shift-"+e+"L"]="splitSelectionByLine"]=function(a){for(var c=a.listSelections(),d=[],h=0;h<c.length;h++)for(var b=c[h].from(),e=c[h].to(),g=b.line;g<=e.line;++g)e.line>b.line&&g==e.line&&0==e.ch||d.push({anchor:g==b.line?b:l(g,0),head:g==
e.line?e:l(g)});a.setSelections(d,0)};b["Shift-Tab"]="indentLess";f[b.Esc="singleSelectionTop"]=function(a){var c;if((c=a.listSelections())&&1<c.length)c=c[0],a.setSelection(c.anchor,c.head,{scroll:!1});else return k.Pass};f[b[e+"L"]="selectLine"]=function(a){for(var c=a.listSelections(),d=[],h=0;h<c.length;h++){var b=c[h];d.push({anchor:l(b.from().line,0),head:l(b.to().line+1,0)})}a.setSelections(d)};b["Shift-"+e+"K"]="deleteLine";f[b[e+"Enter"]="insertLineAfter"]=function(a){u(a,!1)};f[b["Shift-"+
e+"Enter"]="insertLineBefore"]=function(a){u(a,!0)};f[b[e+"D"]="selectNextOccurrence"]=function(a){var c=a.getCursor("from"),d=a.getCursor("to"),b=a.state.sublimeFindFullWord==a.doc.sel;if(0==k.cmpPos(c,d)){b=r(a,c);if(!b.word)return;a.setSelection(b.from,b.to);b=!0}else c=a.getRange(c,d),c=b?new RegExp("\\b"+c+"\\b"):c,d=a.getSearchCursor(c,d),d.findNext()?a.addSelection(d.from(),d.to()):(d=a.getSearchCursor(c,l(a.firstLine(),0)),d.findNext()&&a.addSelection(d.from(),d.to()));b&&(a.state.sublimeFindFullWord=
a.doc.sel)};f[b["Shift-"+e+"Space"]="selectScope"]=function(a){v(a)||a.execCommand("selectAll")};f[b["Shift-"+e+"M"]="selectBetweenBrackets"]=function(a){if(!v(a))return k.Pass};f[b[e+"M"]="goToBracket"]=function(a){a.extendSelectionsBy(function(c){var d=a.scanForBracket(c.head,1);return d&&0!=k.cmpPos(d.pos,c.head)?d.pos:(d=a.scanForBracket(c.head,-1))&&l(d.pos.line,d.pos.ch+1)||c.head})};n=n?"Cmd-Ctrl-":"Shift-Ctrl-";f[b[n+"Up"]="swapLineUp"]=function(a){for(var c=a.listSelections(),d=[],b=a.firstLine()-
1,e=[],f=0;f<c.length;f++){var g=c[f],k=g.from().line-1,n=g.to().line;e.push({anchor:l(g.anchor.line-1,g.anchor.ch),head:l(g.head.line-1,g.head.ch)});0!=g.to().ch||g.empty()||--n;k>b?d.push(k,n):d.length&&(d[d.length-1]=n);b=n}a.operation(function(){for(var c=0;c<d.length;c+=2){var b=d[c],h=d[c+1],g=a.getLine(b);a.replaceRange("",l(b,0),l(b+1,0),"+swapLine");h>a.lastLine()?a.replaceRange("\n"+g,l(a.lastLine()),null,"+swapLine"):a.replaceRange(g+"\n",l(h,0),null,"+swapLine")}a.setSelections(e);a.scrollIntoView()})};
f[b[n+"Down"]="swapLineDown"]=function(a){for(var c=a.listSelections(),d=[],b=a.lastLine()+1,e=c.length-1;0<=e;e--){var f=c[e],g=f.to().line+1,k=f.from().line;0!=f.to().ch||f.empty()||g--;g<b?d.push(g,k):d.length&&(d[d.length-1]=k);b=k}a.operation(function(){for(var c=d.length-2;0<=c;c-=2){var b=d[c],h=d[c+1],e=a.getLine(b);b==a.lastLine()?a.replaceRange("",l(b-1),l(b),"+swapLine"):a.replaceRange("",l(b,0),l(b+1,0),"+swapLine");a.replaceRange(e+"\n",l(h,0),null,"+swapLine")}a.scrollIntoView()})};
f[b[e+"/"]=b[e+"7"]="toggleComment"]=function(a){a.toggleComment({indent:!0})};f[b[e+"Shift-/"]=b[e+"Shift-7"]="toggleBlockComment"]=function(a){a.toggleComment({indent:!0,blockComment:!0})};f[b[e+"J"]="joinLines"]=function(a){for(var c=a.listSelections(),d=[],b=0;b<c.length;b++){for(var e=c[b],f=e.from(),g=f.line,k=e.to().line;b<c.length-1&&c[b+1].from().line==k;)k=c[++b].to().line;d.push({start:g,end:k,anchor:!e.empty()&&f})}a.operation(function(){for(var c=0,b=[],h=0;h<d.length;h++){for(var e=
d[h],f=e.anchor&&l(e.anchor.line-c,e.anchor.ch),g,m=e.start;m<=e.end;m++){var k=m-c;m==e.end&&(g=l(k,a.getLine(k).length+1));k<a.lastLine()&&(a.replaceRange(" ",l(k),l(k+1,/^\s*/.exec(a.getLine(k+1))[0].length)),++c)}b.push({anchor:f||g,head:g})}a.setSelections(b,0)})};f[b["Shift-"+e+"D"]="duplicateLine"]=function(a){a.operation(function(){for(var c=a.listSelections().length,d=0;d<c;d++){var b=a.listSelections()[d];b.empty()?a.replaceRange(a.getLine(b.head.line)+"\n",l(b.head.line,0)):a.replaceRange(a.getRange(b.from(),
b.to()),b.from())}a.scrollIntoView()})};b[e+"T"]="transposeChars";f[b.F9="sortLines"]=function(a){w(a,!0)};f[b[e+"F9"]="sortLinesInsensitive"]=function(a){w(a,!1)};f[b.F2="nextBookmark"]=function(a){var c=a.state.sublimeBookmarks;if(c)for(;c.length;){var d=c.shift(),b=d.find();if(b)return c.push(d),a.setSelection(b.from,b.to)}};f[b["Shift-F2"]="prevBookmark"]=function(a){var c=a.state.sublimeBookmarks;if(c)for(;c.length;){c.unshift(c.pop());var d=c[c.length-1].find();if(d)return a.setSelection(d.from,
d.to);c.pop()}};f[b[e+"F2"]="toggleBookmark"]=function(a){for(var c=a.listSelections(),d=a.state.sublimeBookmarks||(a.state.sublimeBookmarks=[]),b=0;b<c.length;b++){for(var e=c[b].from(),f=c[b].to(),g=a.findMarks(e,f),k=0;k<g.length;k++)if(g[k].sublimeBookmark){g[k].clear();for(var l=0;l<d.length;l++)d[l]==g[k]&&d.splice(l--,1);break}k==g.length&&d.push(a.markText(e,f,{sublimeBookmark:!0,clearWhenEmpty:!1}))}};f[b["Shift-"+e+"F2"]="clearBookmarks"]=function(a){if(a=a.state.sublimeBookmarks)for(var c=
0;c<a.length;c++)a[c].clear();a.length=0};f[b["Alt-F2"]="selectBookmarks"]=function(a){var c=a.state.sublimeBookmarks,b=[];if(c)for(var e=0;e<c.length;e++){var f=c[e].find();f?b.push({anchor:f.from,head:f.to}):c.splice(e--,0)}b.length&&a.setSelections(b,0)};b["Alt-Q"]="wrapLines";n=e+"K ";b[n+e+"Backspace"]="delLineLeft";f[b.Backspace="smartBackspace"]=function(a){if(a.somethingSelected())return k.Pass;var c=a.getCursor(),b=a.getRange({line:c.line,ch:0},c),e=k.countColumn(b,null,a.getOption("tabSize")),
f=a.getOption("indentUnit");return b&&!/\S/.test(b)&&0==e%f?(b=new l(c.line,k.findColumn(b,e-f,f)),b.ch==c.ch?k.Pass:a.replaceRange("",b,c,"+delete")):k.Pass};f[b[n+e+"K"]="delLineRight"]=function(a){a.operation(function(){for(var c=a.listSelections(),b=c.length-1;0<=b;b--)a.replaceRange("",c[b].anchor,l(c[b].to().line),"+delete");a.scrollIntoView()})};f[b[n+e+"U"]="upcaseAtCursor"]=function(a){x(a,function(a){return a.toUpperCase()})};f[b[n+e+"L"]="downcaseAtCursor"]=function(a){x(a,function(a){return a.toLowerCase()})};
f[b[n+e+"Space"]="setSublimeMark"]=function(a){a.state.sublimeMark&&a.state.sublimeMark.clear();a.state.sublimeMark=a.setBookmark(a.getCursor())};f[b[n+e+"A"]="selectToSublimeMark"]=function(a){var b=a.state.sublimeMark&&a.state.sublimeMark.find();b&&a.setSelection(a.getCursor(),b)};f[b[n+e+"W"]="deleteToSublimeMark"]=function(a){var b=a.state.sublimeMark&&a.state.sublimeMark.find();if(b){var d=a.getCursor();if(0<k.cmpPos(d,b))var e=b,b=d,d=e;a.state.sublimeKilled=a.getRange(d,b);a.replaceRange("",
d,b)}};f[b[n+e+"X"]="swapWithSublimeMark"]=function(a){var b=a.state.sublimeMark&&a.state.sublimeMark.find();b&&(a.state.sublimeMark.clear(),a.state.sublimeMark=a.setBookmark(a.getCursor()),a.setCursor(b))};f[b[n+e+"Y"]="sublimeYank"]=function(a){null!=a.state.sublimeKilled&&a.replaceSelection(a.state.sublimeKilled,null,"paste")};b[n+e+"G"]="clearBookmarks";f[b[n+e+"C"]="showInCenter"]=function(a){var b=a.cursorCoords(null,"local");a.scrollTo(null,(b.top+b.bottom)/2-a.getScrollInfo().clientHeight/
2)};f[b["Shift-Alt-Up"]="selectLinesUpward"]=function(a){a.operation(function(){for(var b=a.listSelections(),d=0;d<b.length;d++){var e=b[d];e.head.line>a.firstLine()&&a.addSelection(l(e.head.line-1,e.head.ch))}})};f[b["Shift-Alt-Down"]="selectLinesDownward"]=function(a){a.operation(function(){for(var b=a.listSelections(),d=0;d<b.length;d++){var e=b[d];e.head.line<a.lastLine()&&a.addSelection(l(e.head.line+1,e.head.ch))}})};f[b[e+"F3"]="findUnder"]=function(a){z(a,!0)};f[b["Shift-"+e+"F3"]="findUnderPrevious"]=
function(a){z(a,!1)};f[b["Alt-F3"]="findAllUnder"]=function(a){var b=y(a);if(b){for(var d=a.getSearchCursor(b.query),e=[],f=-1;d.findNext();)e.push({anchor:d.from(),head:d.to()}),d.from().line<=b.from.line&&d.from().ch<=b.from.ch&&f++;a.setSelections(e,f)}};b["Shift-"+e+"["]="fold";b["Shift-"+e+"]"]="unfold";b[n+e+"0"]=b[n+e+"j"]="unfoldAll";b[e+"I"]="findIncremental";b["Shift-"+e+"I"]="findIncrementalReverse";b[e+"H"]="replace";b.F3="findNext";b["Shift-F3"]="findPrev";k.normalizeKeyMap(b)});
